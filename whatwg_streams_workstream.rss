<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>WHATWG Streams Workstream-relevant MDN issues</title>
        <link>https://dontcallmedom.github.io/mdn-issue-by-spec/whatwg_streams_workstream.rss</link>
        <description>Issue filed on MDN Web Docs related to pages attached to technologies developed by WHATWG Streams Workstream</description>
        <lastBuildDate>Sun, 26 Dec 2021 17:35:24 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>en</language>
        <item>
            <title><![CDATA[[streams] Issue with "WritableStreamDefaultWriter": (Incorrect/Problematic Example)]]></title>
            <link>https://github.com/mdn/content/issues/11494</link>
            <guid>https://github.com/mdn/content/issues/11494</guid>
            <pubDate>Sun, 26 Dec 2021 17:35:24 GMT</pubDate>
            <content:encoded><![CDATA[<p dir="auto">MDN URL: <a href="https://developer.mozilla.org/en-US/docs/Web/API/WritableStreamDefaultWriter" rel="nofollow">https://developer.mozilla.org/en-US/docs/Web/API/WritableStreamDefaultWriter</a></p>
<h4 dir="auto">What information was incorrect, unhelpful, or incomplete?</h4>
<p dir="auto">Im am referring to this example currently on<br>
<a href="https://developer.mozilla.org/en-US/docs/Web/API/WritableStreamDefaultWriter" rel="nofollow">https://developer.mozilla.org/en-US/docs/Web/API/WritableStreamDefaultWriter</a>:</p>
<div class="highlight highlight-source-js notranslate position-relative overflow-auto" dir="auto" data-snippet-clipboard-copy-content="const list = document.querySelector('ul');

function sendMessage(message, writableStream) {
	// defaultWriter is of type WritableStreamDefaultWriter
	const defaultWriter = writableStream.getWriter();
	const encoder = new TextEncoder();
	const encoded = encoder.encode(message, { stream: true });
	encoded.forEach((chunk) =&gt; {
		defaultWriter.ready
			.then(() =&gt; {
				return defaultWriter.write(chunk);
			})
			.then(() =&gt; {
				console.log(&quot;Chunk written to sink.&quot;);
			})
			.catch((err) =&gt; {
				console.log(&quot;Chunk error:&quot;, err);
			});
	});
	// Call ready again to ensure that all chunks are written
	//   before closing the writer.
	defaultWriter.ready
		.then(() =&gt; {
			defaultWriter.close();
		})
		.then(() =&gt; {
			console.log(&quot;All chunks written&quot;);
		})
		.catch((err) =&gt; {
			console.log(&quot;Stream error:&quot;, err);
		});
}

const decoder = new TextDecoder(&quot;utf-8&quot;);
const queuingStrategy = new CountQueuingStrategy({ highWaterMark: 1 });
let result = &quot;&quot;;
const writableStream = new WritableStream({
	// Implement the sink
	write(chunk) {
		return new Promise((resolve, reject) =&gt; {
			var buffer = new ArrayBuffer(2);
			var view = new Uint16Array(buffer);
			view[0] = chunk;
			var decoded = decoder.decode(view, { stream: true });
			var listItem = document.createElement('li');
			listItem.textContent = &quot;Chunk decoded: &quot; + decoded;
			list.appendChild(listItem);
			result += decoded;
			resolve();
		});
	},
	close() {
		var listItem = document.createElement('li');
		listItem.textContent = &quot;[MESSAGE RECEIVED] &quot; + result;
		list.appendChild(listItem);
	},
	abort(err) {
		console.log(&quot;Sink error:&quot;, err);
	}
}, queuingStrategy);

sendMessage(&quot;Hello, world.&quot;, writableStream);
"><pre><span class="pl-k">const</span> <span class="pl-s1">list</span> <span class="pl-c1">=</span> <span class="pl-smi">document</span><span class="pl-kos">.</span><span class="pl-en">querySelector</span><span class="pl-kos">(</span><span class="pl-s">'ul'</span><span class="pl-kos">)</span><span class="pl-kos">;</span>

<span class="pl-k">function</span> <span class="pl-en">sendMessage</span><span class="pl-kos">(</span><span class="pl-s1">message</span><span class="pl-kos">,</span> <span class="pl-s1">writableStream</span><span class="pl-kos">)</span> <span class="pl-kos">{</span>
	<span class="pl-c">// defaultWriter is of type WritableStreamDefaultWriter</span>
	<span class="pl-k">const</span> <span class="pl-s1">defaultWriter</span> <span class="pl-c1">=</span> <span class="pl-s1">writableStream</span><span class="pl-kos">.</span><span class="pl-en">getWriter</span><span class="pl-kos">(</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
	<span class="pl-k">const</span> <span class="pl-s1">encoder</span> <span class="pl-c1">=</span> <span class="pl-k">new</span> <span class="pl-v">TextEncoder</span><span class="pl-kos">(</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
	<span class="pl-k">const</span> <span class="pl-s1">encoded</span> <span class="pl-c1">=</span> <span class="pl-s1">encoder</span><span class="pl-kos">.</span><span class="pl-en">encode</span><span class="pl-kos">(</span><span class="pl-s1">message</span><span class="pl-kos">,</span> <span class="pl-kos">{</span> <span class="pl-c1">stream</span>: <span class="pl-c1">true</span> <span class="pl-kos">}</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
	<span class="pl-s1">encoded</span><span class="pl-kos">.</span><span class="pl-en">forEach</span><span class="pl-kos">(</span><span class="pl-kos">(</span><span class="pl-s1">chunk</span><span class="pl-kos">)</span> <span class="pl-c1">=&gt;</span> <span class="pl-kos">{</span>
		<span class="pl-s1">defaultWriter</span><span class="pl-kos">.</span><span class="pl-c1">ready</span>
			<span class="pl-kos">.</span><span class="pl-en">then</span><span class="pl-kos">(</span><span class="pl-kos">(</span><span class="pl-kos">)</span> <span class="pl-c1">=&gt;</span> <span class="pl-kos">{</span>
				<span class="pl-k">return</span> <span class="pl-s1">defaultWriter</span><span class="pl-kos">.</span><span class="pl-en">write</span><span class="pl-kos">(</span><span class="pl-s1">chunk</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
			<span class="pl-kos">}</span><span class="pl-kos">)</span>
			<span class="pl-kos">.</span><span class="pl-en">then</span><span class="pl-kos">(</span><span class="pl-kos">(</span><span class="pl-kos">)</span> <span class="pl-c1">=&gt;</span> <span class="pl-kos">{</span>
				<span class="pl-smi">console</span><span class="pl-kos">.</span><span class="pl-en">log</span><span class="pl-kos">(</span><span class="pl-s">"Chunk written to sink."</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
			<span class="pl-kos">}</span><span class="pl-kos">)</span>
			<span class="pl-kos">.</span><span class="pl-en">catch</span><span class="pl-kos">(</span><span class="pl-kos">(</span><span class="pl-s1">err</span><span class="pl-kos">)</span> <span class="pl-c1">=&gt;</span> <span class="pl-kos">{</span>
				<span class="pl-smi">console</span><span class="pl-kos">.</span><span class="pl-en">log</span><span class="pl-kos">(</span><span class="pl-s">"Chunk error:"</span><span class="pl-kos">,</span> <span class="pl-s1">err</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
			<span class="pl-kos">}</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
	<span class="pl-kos">}</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
	<span class="pl-c">// Call ready again to ensure that all chunks are written</span>
	<span class="pl-c">//   before closing the writer.</span>
	<span class="pl-s1">defaultWriter</span><span class="pl-kos">.</span><span class="pl-c1">ready</span>
		<span class="pl-kos">.</span><span class="pl-en">then</span><span class="pl-kos">(</span><span class="pl-kos">(</span><span class="pl-kos">)</span> <span class="pl-c1">=&gt;</span> <span class="pl-kos">{</span>
			<span class="pl-s1">defaultWriter</span><span class="pl-kos">.</span><span class="pl-en">close</span><span class="pl-kos">(</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
		<span class="pl-kos">}</span><span class="pl-kos">)</span>
		<span class="pl-kos">.</span><span class="pl-en">then</span><span class="pl-kos">(</span><span class="pl-kos">(</span><span class="pl-kos">)</span> <span class="pl-c1">=&gt;</span> <span class="pl-kos">{</span>
			<span class="pl-smi">console</span><span class="pl-kos">.</span><span class="pl-en">log</span><span class="pl-kos">(</span><span class="pl-s">"All chunks written"</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
		<span class="pl-kos">}</span><span class="pl-kos">)</span>
		<span class="pl-kos">.</span><span class="pl-en">catch</span><span class="pl-kos">(</span><span class="pl-kos">(</span><span class="pl-s1">err</span><span class="pl-kos">)</span> <span class="pl-c1">=&gt;</span> <span class="pl-kos">{</span>
			<span class="pl-smi">console</span><span class="pl-kos">.</span><span class="pl-en">log</span><span class="pl-kos">(</span><span class="pl-s">"Stream error:"</span><span class="pl-kos">,</span> <span class="pl-s1">err</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
		<span class="pl-kos">}</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
<span class="pl-kos">}</span>

<span class="pl-k">const</span> <span class="pl-s1">decoder</span> <span class="pl-c1">=</span> <span class="pl-k">new</span> <span class="pl-v">TextDecoder</span><span class="pl-kos">(</span><span class="pl-s">"utf-8"</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
<span class="pl-k">const</span> <span class="pl-s1">queuingStrategy</span> <span class="pl-c1">=</span> <span class="pl-k">new</span> <span class="pl-v">CountQueuingStrategy</span><span class="pl-kos">(</span><span class="pl-kos">{</span> <span class="pl-c1">highWaterMark</span>: <span class="pl-c1">1</span> <span class="pl-kos">}</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
<span class="pl-k">let</span> <span class="pl-s1">result</span> <span class="pl-c1">=</span> <span class="pl-s">""</span><span class="pl-kos">;</span>
<span class="pl-k">const</span> <span class="pl-s1">writableStream</span> <span class="pl-c1">=</span> <span class="pl-k">new</span> <span class="pl-v">WritableStream</span><span class="pl-kos">(</span><span class="pl-kos">{</span>
	<span class="pl-c">// Implement the sink</span>
	<span class="pl-en">write</span><span class="pl-kos">(</span><span class="pl-s1">chunk</span><span class="pl-kos">)</span> <span class="pl-kos">{</span>
		<span class="pl-k">return</span> <span class="pl-k">new</span> <span class="pl-v">Promise</span><span class="pl-kos">(</span><span class="pl-kos">(</span><span class="pl-s1">resolve</span><span class="pl-kos">,</span> <span class="pl-s1">reject</span><span class="pl-kos">)</span> <span class="pl-c1">=&gt;</span> <span class="pl-kos">{</span>
			<span class="pl-k">var</span> <span class="pl-s1">buffer</span> <span class="pl-c1">=</span> <span class="pl-k">new</span> <span class="pl-v">ArrayBuffer</span><span class="pl-kos">(</span><span class="pl-c1">2</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
			<span class="pl-k">var</span> <span class="pl-s1">view</span> <span class="pl-c1">=</span> <span class="pl-k">new</span> <span class="pl-v">Uint16Array</span><span class="pl-kos">(</span><span class="pl-s1">buffer</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
			<span class="pl-s1">view</span><span class="pl-kos">[</span><span class="pl-c1">0</span><span class="pl-kos">]</span> <span class="pl-c1">=</span> <span class="pl-s1">chunk</span><span class="pl-kos">;</span>
			<span class="pl-k">var</span> <span class="pl-s1">decoded</span> <span class="pl-c1">=</span> <span class="pl-s1">decoder</span><span class="pl-kos">.</span><span class="pl-en">decode</span><span class="pl-kos">(</span><span class="pl-s1">view</span><span class="pl-kos">,</span> <span class="pl-kos">{</span> <span class="pl-c1">stream</span>: <span class="pl-c1">true</span> <span class="pl-kos">}</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
			<span class="pl-k">var</span> <span class="pl-s1">listItem</span> <span class="pl-c1">=</span> <span class="pl-smi">document</span><span class="pl-kos">.</span><span class="pl-en">createElement</span><span class="pl-kos">(</span><span class="pl-s">'li'</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
			<span class="pl-s1">listItem</span><span class="pl-kos">.</span><span class="pl-c1">textContent</span> <span class="pl-c1">=</span> <span class="pl-s">"Chunk decoded: "</span> <span class="pl-c1">+</span> <span class="pl-s1">decoded</span><span class="pl-kos">;</span>
			<span class="pl-s1">list</span><span class="pl-kos">.</span><span class="pl-en">appendChild</span><span class="pl-kos">(</span><span class="pl-s1">listItem</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
			<span class="pl-s1">result</span> <span class="pl-c1">+=</span> <span class="pl-s1">decoded</span><span class="pl-kos">;</span>
			<span class="pl-s1">resolve</span><span class="pl-kos">(</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
		<span class="pl-kos">}</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
	<span class="pl-kos">}</span><span class="pl-kos">,</span>
	<span class="pl-en">close</span><span class="pl-kos">(</span><span class="pl-kos">)</span> <span class="pl-kos">{</span>
		<span class="pl-k">var</span> <span class="pl-s1">listItem</span> <span class="pl-c1">=</span> <span class="pl-smi">document</span><span class="pl-kos">.</span><span class="pl-en">createElement</span><span class="pl-kos">(</span><span class="pl-s">'li'</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
		<span class="pl-s1">listItem</span><span class="pl-kos">.</span><span class="pl-c1">textContent</span> <span class="pl-c1">=</span> <span class="pl-s">"[MESSAGE RECEIVED] "</span> <span class="pl-c1">+</span> <span class="pl-s1">result</span><span class="pl-kos">;</span>
		<span class="pl-s1">list</span><span class="pl-kos">.</span><span class="pl-en">appendChild</span><span class="pl-kos">(</span><span class="pl-s1">listItem</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
	<span class="pl-kos">}</span><span class="pl-kos">,</span>
	<span class="pl-en">abort</span><span class="pl-kos">(</span><span class="pl-s1">err</span><span class="pl-kos">)</span> <span class="pl-kos">{</span>
		<span class="pl-smi">console</span><span class="pl-kos">.</span><span class="pl-en">log</span><span class="pl-kos">(</span><span class="pl-s">"Sink error:"</span><span class="pl-kos">,</span> <span class="pl-s1">err</span><span class="pl-kos">)</span><span class="pl-kos">;</span>
	<span class="pl-kos">}</span>
<span class="pl-kos">}</span><span class="pl-kos">,</span> <span class="pl-s1">queuingStrategy</span><span class="pl-kos">)</span><span class="pl-kos">;</span>

<span class="pl-en">sendMessage</span><span class="pl-kos">(</span><span class="pl-s">"Hello, world."</span><span class="pl-kos">,</span> <span class="pl-s1">writableStream</span><span class="pl-kos">)</span><span class="pl-kos">;</span></pre></div>
<p dir="auto">Preliminary note: Note that <code class="notranslate">then</code> is called multiple<br>
times <em>on the same</em> <code class="notranslate">Promise</code> (branching, not chaining):<br>
<code class="notranslate">defaultWriter.ready.then</code> is called multiple times.</p>
<p dir="auto">When a write <code class="notranslate">Promise</code> rejects, we see the problems with<br>
the code. Assume the first chunk's write promise rejects:</p>
<ul dir="auto">
<li>
<p dir="auto">The error handler printing <code class="notranslate">"Chunk error:", err</code> is called<br>
13 times (not just once for the failing chunk): all<br>
chunks (their "tasks") are immediately enqueued by<br>
<code class="notranslate">defaultWriter.ready</code> (not in the writer/stream's queue).</p>
</li>
<li>
<p dir="auto">The error handler registered for the closing task<br>
(printing <code class="notranslate">"Stream error:", err</code>) is not called at all.<br>
The error resulting from calling <code class="notranslate">defaultWriter.close()</code><br>
is unhandled. Instead of:</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="defaultWriter.close();"><pre class="notranslate notranslate"><code>defaultWriter.close();
</code></pre></div>
<p dir="auto">it should be</p>
<div class="snippet-clipboard-content notranslate position-relative overflow-auto" data-snippet-clipboard-copy-content="return defaultWriter.close();"><pre class="notranslate notranslate"><code>return defaultWriter.close();
</code></pre></div>
</li>
</ul>
<h4 dir="auto">Specific section or headline?</h4>
<p dir="auto">Section "Examples": <a href="https://developer.mozilla.org/en-US/docs/Web/API/WritableStreamDefaultWriter#examples" rel="nofollow">https://developer.mozilla.org/en-US/docs/Web/API/WritableStreamDefaultWriter#examples</a></p>
<p dir="auto">Note that the example might also be here: <a href="https://developer.mozilla.org/en-US/docs/Web/API/WritableStreamDefaultWriter/close" rel="nofollow">https://developer.mozilla.org/en-US/docs/Web/API/WritableStreamDefaultWriter/close</a></p>
<h4 dir="auto">What did you expect to see?</h4>
<p dir="auto">I would love to see an example that:</p>
<ul dir="auto">
<li>handles errors / <code class="notranslate">Promise</code> rejections decently (handling a single error once, no unhandled errors, handling errors from <code class="notranslate">close</code>, no writing attempts after error)</li>
<li>does not use "branching" <code class="notranslate">then</code> when "chaining" <code class="notranslate">then</code> or <code class="notranslate">async</code>/<code class="notranslate">await</code> could easily be used (this example shows the confusion that can arise)</li>
</ul>
<h4 dir="auto">Did you test this? If so, how?</h4>
<p dir="auto">Yes, I tested this. To reproduce:</p>
<ul dir="auto">
<li>Download the code from "<a href="https://mdn.github.io/dom-examples/streams/simple-writer/" rel="nofollow">https://mdn.github.io/dom-examples/streams/simple-writer/</a>"</li>
<li><code class="notranslate">reject</code> some <code class="notranslate">Promise</code> (the one already explicitly in the code or add one to <code class="notranslate">reject</code>).</li>
<li>Run the code in a browser already supporting <code class="notranslate">WritableStream</code>s.</li>
</ul>

<details>
<summary>MDN Content page report details</summary>
<ul dir="auto">
<li>Folder: <code class="notranslate">en-us/web/api/writablestreamdefaultwriter</code></li>
<li>MDN URL: <a href="https://developer.mozilla.org/en-US/docs/Web/API/WritableStreamDefaultWriter" rel="nofollow">https://developer.mozilla.org/en-US/docs/Web/API/WritableStreamDefaultWriter</a></li>
<li>GitHub URL: <a href="https://github.com/mdn/content/blob/main/files/en-us/web/api/writablestreamdefaultwriter/index.md">https://github.com/mdn/content/blob/main/files/en-us/web/api/writablestreamdefaultwriter/index.md</a></li>
<li>Last commit: <a class="commit-link" data-hovercard-type="commit" data-hovercard-url="https://github.com/mdn/content/commit/2279e5ae6c229c707a014a22aa1ec4635a0f981f/hovercard" href="https://github.com/mdn/content/commit/2279e5ae6c229c707a014a22aa1ec4635a0f981f"><tt>2279e5a</tt></a></li>
<li>Document last modified: 2021-09-14T18:08:09.000Z</li>
</ul>
</details>]]></content:encoded>
        </item>
    </channel>
</rss>